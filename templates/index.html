<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
 
    <title>Transforma tu mundoüåé &#8211; Twogether</title>
    <!-- Add any additional stylesheets or scripts here -->
</head>

<body>

    <div class="container-xxl h-100 d-flex flex-column align-items-center justify-content-center">
        <form class="my-3 form-control text-light" method="POST" id="formEnvio" style="background-color: #2E318E;">
          <div class="mb-3">
              <label for="nombreCompleto" class="form-label">‚úÖ Nombre completo:</label>
              <input type="text" class="form-control" id="nombreCompleto" name="nombreCompleto" placeholder="Nombres y apellidos por favor" required>
          </div>
          <div class="mb-3">
              <label for="paisResidencia" class="form-label">‚úÖ Pa√≠s de residencia:</label>
              <select class="form-select" id="paisResidencia" name="paisResidencia" required>
                  <option value="CO">Colombia</option>
                  <option value="EEUU">EEUU</option>
                  <option value="Mexico">Mexico</option>
                  <option value="Espa√±a">Espa√±a</option>
                  <option value="Alemania">Alemania</option>
                  <option value="Canada">Canada</option>
                  <option value="Francia">Francia</option>
                  <option value="Brasil">Brasil</option>
                  <option value="Italia">Italia</option>
                  <option value="Belgica">B√©lgica</option>
                  <!-- Puedes agregar m√°s opciones de pa√≠ses seg√∫n sea necesario -->
              </select>
          </div>
          <div class="mb-3">
              <label for="numeroDocumento" class="form-label">‚úÖ N√∫mero del Documento de Identificaci√≥n:</label>
              <input type="text" class="form-control" id="numeroDocumento" name="numeroDocumento" placeholder="C√©dula, DNI, ID, driver licence" required>
          </div>
          <div class="mb-3">
              <label for="numeroContacto" class="form-label">‚úÖ N√∫mero contacto:</label>
              <input type="text" class="form-control" id="numeroContacto" name="numeroContacto" placeholder="Sin indicativo de pa√≠s, preferiblemente con WhatsApp" required>
          </div>
          <div class="mb-3">
              <label for="correoElectronico" class="form-label">‚úÖ Correo electr√≥nico:</label>
              <input type="email" class="form-control" id="correoElectronico" name="correoElectronico" placeholder="Personal o empresarial" required>
          </div>
          <div class="mb-3">
              <label for="fechaNacimiento" class="form-label">‚úÖ Fecha de nacimiento:</label>
              <input type="date" class="form-control" id="fechaNacimiento" name="fechaNacimiento" required>
          </div>
          <div class="mb-3">
              <label for="idReferidor" class="form-label">‚úÖ Escribe el ID Twogether de quien te invit√≥:</label>
              <input type="text" class="form-control" id="idReferidor" name="idReferidor" placeholder="Recuerda revisar el mensaje de invitaci√≥n" required>
          </div>
          <div>
            <p>FELICITACIONES, Si has llegado hasta este punto es por que has tomado la decisi√≥n de ganar dinero por tus compras, marca las casillas recordando los pasos que vas a cumplir: </p>
          </div>
          <div class="form-check mb-3">
              <input type="checkbox" class="form-check-input" id="pasosCumplidos1" name="pasosCumplidos" required>
              <label class="form-check-label" for="pasosCumplidos"> Paso 1: Me registro en la Comunidad Twogether.</label>
          </div>
          <div class="form-check mb-3">
            <input type="checkbox" class="form-check-input" id="pasosCumplidos2" name="pasosCumplidos" required>
            <label class="form-check-label" for="pasosCumplidos">Paso 2: Env√≠o el link de invitaci√≥n con el prop√≥sito de beneficiar a 2 personas a la comunidad, meta que debo lograr como m√°ximo en 2 d√≠as.</label>
        </div>
        <div class="form-check mb-3">
          <input type="checkbox" class="form-check-input" id="pasosCumplidos3" name="pasosCumplidos" required>
          <label class="form-check-label" for="pasosCumplidos">Paso 3: Realizo mi compra el dia asignado (Sustituyo productos que ya consumo por un valor aproximado de $200 USD o 100.000 puntos)</label>
      </div>
      <div class="form-check mb-3">
        <input type="checkbox" class="form-check-input" id="pasosCumplidos4" name="pasosCumplidos" required>
        <label class="form-check-label" for="pasosCumplidos">Paso 4: Recibo ganancias de la Plataforma Global E-Commerce.</label>
    </div>
          <button type="button" class="btn btn-warning form-control" id="enviar" style="background-color: #F18F15;">Quiero ser parte de la comunidad Twogether</button>
          
           <!-- Modal -->
           <div class="modal fade text-dark" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">Validaciones Twogether</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  Espera mientras validamos el IDTwogether que ingresaste: <span id="text-input"></span>
                  <br>
                  <div id="spinner" class="spinner-border text-success text-center my-auto mx-auto" role="status">
                      <span class="visually-hidden">Loading...  </span>
                  </div>
  
                  
                </div>
                <div class="modal-footer" id="registro">
                  <button type="button" class="btn btn-warning form-control" data-bs-dismiss="modal" >Registarme</button>
                </div>
              </div>
            </div>
          </div>
      </form>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Add any additional scripts here -->
<span class="fw-bolder"></span>
<script>

  async function obtenerNombreReferidor(idReferidor) {
    const url = `/getuser?userID=${idReferidor}`;

    try {
      const response = await fetch(url, {
        method: 'GET',
        headers: {'Content-Type': 'application/json'}
      });

      const data = await response.json();

      if (data.code === 200) {
        return data.user[0].nombreCompleto;
      } else {
        // Manejar el caso en que el c√≥digo no sea 200 (por ejemplo, mostrar un mensaje de error)
        throw new Error("Usuario no encontrado en la base de datos");
      }
    } catch (error) {
      // Manejar errores de la solicitud (por ejemplo, mostrar un mensaje de error)
      throw new Error('Error al realizar la solicitud: ' + error.message);
    }
  }


  var nombreReferidorGlobal;
  const enviar = document.querySelector("#enviar");
  const loadingModal = new bootstrap.Modal(document.getElementById('exampleModal'));

  enviar.addEventListener("click", () => {
    const registro = document.querySelector("#registro");
    const idReferidor = document.querySelector("#idReferidor").value;
    const textInput = document.querySelector("#text-input");
    
    registro.innerHTML = "";
    textInput.innerHTML = `<span class="fw-bolder text-center"> ${idReferidor}</span>`;

    const nombreCompleto = document.getElementById('nombreCompleto').value;
    const paisResidencia = document.getElementById('paisResidencia').value;
    const numeroDocumento = document.getElementById('numeroDocumento').value;
    const numeroContacto = document.getElementById('numeroContacto').value;
    const correoElectronico = document.getElementById('correoElectronico').value;
    const fechaNacimiento = document.getElementById('fechaNacimiento').value;
    //const nombreReferidor = document.getElementById('nombreReferidor').value;
    const pasosCumplidos1 = document.getElementById('pasosCumplidos1').checked;
    const pasosCumplidos2 = document.getElementById('pasosCumplidos2').checked;
    const pasosCumplidos3 = document.getElementById('pasosCumplidos3').checked;
    const pasosCumplidos4 = document.getElementById('pasosCumplidos4').checked;
    const spinner = document.querySelector("#spinner");
    
     // Validar que todos los campos est√©n llenos
     if (
        !nombreCompleto ||
        !paisResidencia ||
        !numeroDocumento ||
        !numeroContacto ||
        !correoElectronico ||
        !fechaNacimiento ||
        //!nombreReferidor ||
        !idReferidor ||
        !pasosCumplidos1 || 
        !pasosCumplidos2 || 
        !pasosCumplidos3 || 
        !pasosCumplidos4 
    ) {
        // Al menos un campo est√° vac√≠o, mostrar un mensaje de error o realizar otras acciones seg√∫n sea necesario
        Swal.fire({
          icon: "error",
          title: "Oops...",
          text: "Debes llenar todos los campos",
        });
        // Terminar la ejecuci√≥n de la funci√≥n
        return;
    }
   
    spinner.style.display = "block"; 
    loadingModal.show();

    const url = `/getuser?userID=${idReferidor}`;
    
    // Realizar la solicitud GET usando fetch
    fetch(url, {
      method: 'GET',
      headers: {'Content-Type': 'application/json'}
      })
      .then(response => response.json()) // Parsear la respuesta como JSON
      .then(data => {
        nombreReferidor = data.user[0].nombreCompleto;
        if (data.code == 200) {
            registro.innerHTML = `<p id="capturaNombre"> 
                                      Usuario Referidor Encontrado: <span class="fw-bolder"> ${data.user[0].nombreCompleto} </span>
                                  </p>
                                  <br>
                                  <button type="button" class="btn btn-warning form-control" data-bs-dismiss="modal">Registarme</button>`;
            spinner.style.display = "none";
        } else {
          loadingModal.hide();
            Swal.fire({
            icon: "error",
            title: "Oops...",
            text: "Usuario no encontrado en la base de Datos, por favor revisa",
          });
          spinner.style.display = "block";
          return;
        }
      })
      .catch(error => {
        console.error('Error al realizar la solicitud:', error);
      });


  });

    const registro = document.querySelector("#registro");

    registro.addEventListener("click", async () => {

      const nombreCompleto = document.getElementById('nombreCompleto').value;
      const paisResidencia = document.getElementById('paisResidencia').value;
      const numeroDocumento = document.getElementById('numeroDocumento').value;
      const numeroContacto = document.getElementById('numeroContacto').value;
      const correoElectronico = document.getElementById('correoElectronico').value;
      const fechaNacimiento = document.getElementById('fechaNacimiento').value;
      const pasosCumplidos1 = document.getElementById('pasosCumplidos1').checked;
      const pasosCumplidos2 = document.getElementById('pasosCumplidos2').checked;
      const pasosCumplidos3 = document.getElementById('pasosCumplidos3').checked;
      const pasosCumplidos4 = document.getElementById('pasosCumplidos4').checked;
      const idReferidor = document.querySelector("#idReferidor").value;
      const spinner = document.querySelector("#spinner");
      const nombreReferidor = await obtenerNombreReferidor(idReferidor);

      debugger;

      const jsonData = {
        nombreCompleto,
        paisResidencia,
        numeroDocumento,
        numeroContacto,
        correoElectronico,
        fechaNacimiento,
        nombreReferidor,
        pasosCumplidos: pasosCumplidos1,
        idReferidor
        };

        fetch("/front", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Add any additional headers if needed
                },
                body: JSON.stringify(jsonData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json(); // Assuming the response is in JSON format
                })
                .then(data => {
                  if (data.code == 200) {
                    window.top.location.href = 'https://comunidadtwogether.com/registrotwogether/';
                      } else {
                      loadingModal.hide();
                        Swal.fire({
                        icon: "error",
                        title: "Oops...",
                        text: data.message,
                      });
                      console.log(data)
                      return;
                    }
                })
                .catch(error => {
                    loadingModal.hide();
                    console.error('Update request failed:', error);
                });
            
    });
</script>

</body>
</html>
